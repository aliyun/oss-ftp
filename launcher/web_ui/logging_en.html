<ul class="nav nav-tabs">
    <li class="active" onclick="onSwitchTab('ftp')" ><a data-toggle="tab">OSS-FTP log</a></li>
    <li onclick="onSwitchTab('sftp')"><a data-toggle="tab">OSS-SFTP log</a></li>
</ul>

<div id="log"></div>
<div id="sftp-log" style="display:none"></div>

<style type="text/css">
    .DUMMY { color: black }
    .DEBUG { color: #21610b }
    .INFO { color: blue }
    .WARNING { color: #ff8000 }
    .ERROR { color: #fe2e2e }
    .CRITICAL { color: #d7df01 }
</style>

<script type="text/javascript">
    function onSwitchTab(moduleName) {
        if (moduleName == 'ftp') {
            ftpTimer.play();
            sftpTimer.stop();

		    var ftpDisplay = document.getElementById("sftp-log")
    	    ftpDisplay.style.display = "none";

    	    var sftpDisplay = document.getElementById("log")
    	    sftpDisplay.style.display = "block";
        } else if(moduleName == 'sftp') {
            ftpTimer.stop();
            sftpTimer.play();

		    var ftpDisplay = document.getElementById("log")
    	    ftpDisplay.style.display = "none";

    	    var sftpDisplay = document.getElementById("sftp-log")
    	    sftpDisplay.style.display = "block";
        }
	}
</script>

<!-- JavaScript -->
<script type="text/javascript">
    title('OSS-FTP/SFTP LOG');
</script>
<script type="text/javascript">
    $(function() {
        resizeLogWindow();
    });

    $(window).resize(function() {
        resizeLogWindow();
    });
</script>
<script type="text/javascript">
    function resizeLogWindow() {
        var windowHeight = $(window).height(),
        preservedHeight = 170;
        $('#log').css('height', windowHeight - preservedHeight);
        $('#sftp-log').css('height', windowHeight - preservedHeight);
    }
</script>

<script type="text/javascript">
    function LogAttr() {
        this.previousOffset  = 0;
        this.offset          = 0;
        this.logLineNum      = 0;
        this.filePos = 0;
        this.isAutoScrollLog = true;
        this.isgetLogProcessing = false;
    }
</script>

<script type="text/javascript">
    $(function() {
        window.ftpLog = new LogAttr();
        window.sftpLog = new LogAttr();

        ftpTimer = $.timer(function() {
            getLog("ftp");
        });
        ftpTimer.set({
            time: 500,
            autostart: true
        });

        sftpTimer = $.timer(function() {
            getLog("sftp");
        });
        sftpTimer.set({
            time: 500,
            autostart: false
        });

    });
</script>
<script type="text/javascript">
    $(function() {
        getLog("ftp");
        getLog("sftp");
    });
</script>
<script type="text/javascript">
    $('#log').scroll(function() {
        var preservedHeight = $('#log').height() + 10,
            scrollHeight    = $('#log')[0].scrollHeight,
            scrollTop       = $('#log').scrollTop();

        if ( scrollTop + preservedHeight == scrollHeight ) {
            window.ftpLog.isAutoScrollLog = true;
        } else {
            window.ftpLog.isAutoScrollLog = false;
        }
    });
</script>

<script type="text/javascript">
    $('#sftp-log').scroll(function() {
        var preservedHeight = $('#sftp-log').height() + 10,
            scrollHeight    = $('#sftp-log')[0].scrollHeight,
            scrollTop       = $('#sftp-log').scrollTop();

        if ( scrollTop + preservedHeight == scrollHeight ) {
            window.sftpLog.isAutoScrollLog = true;
        } else {
            window.sftpLog.isAutoScrollLog = false;
        }
    });
</script>

<script type="text/javascript">
    function scrollLog(moduleName) {
        if (moduleName == "ftp") {
            if (window.ftpLog.isAutoScrollLog ) {
                $('#log').scrollTop($('#log')[0].scrollHeight);
            }
        } else if (moduleName == "sftp") {
            if (window.sftpLog.isAutoScrollLog ) {
                $('#sftp-log').scrollTop($('#sftp-log')[0].scrollHeight);
            }
        }
    }
</script>

<script type="text/javascript">
    function getLog(moduleName) {
        var logShow = moduleName == "ftp" ? $('#log') : $('#sftp-log');
        var logHandle = moduleName == "ftp" ? window.ftpLog : window.sftpLog;

        if ( logHandle.isgetLogProcessing ) { return }
        if ( !logHandle.isAutoScrollLog ) { return }

        logHandle.isgetLogProcessing = true;
        var pageRequests = {
                'cmd': 'get_new',
                'last_no': logHandle.offset,
                'last_pos': logHandle.filePos,
                'log_module': moduleName
        };

        $.ajax({
            type: 'GET',
            url: '/log',
            data: pageRequests,
            dataType: 'JSON',
            success: function(result) {
                logHandle.filePos = result.filePos;
                var newlines = document.createDocumentFragment();
                var newlineNum = 0;
                 $.each(result.fileLines, function(lineNumber, log) {
                    logHandle.offset = lineNumber;

                    var logTemplate = '<p class="%s">%s</p>';
                    if ( logHandle.previousOffset != logHandle.offset ) {
                        var newline = $(logTemplate.format(getLogLevel(log), log));
                        $(newlines).append(newline);
                        newlineNum += 1;
                    }
                });
                logHandle.logLineNum += newlineNum;
                logShow.append(newlines);
                var maxLineNum = 1000;
                var cutStep = 10;
                if(logHandle.logLineNum > maxLineNum + cutStep){
                    var numToCut = logHandle.logLineNum - maxLineNum;
                    var textblock = logShow.html();
                    var lines = textblock.split('\n');
                    lines.splice(0,numToCut);
                    var newtext = lines.join('\n');
                    logShow.html(newtext);
                    logHandle.logLineNum -= numToCut;
                }

                scrollLog(moduleName);
                logHandle.previousOffset = logHandle.offset;
                logHandle.isgetLogProcessing = false;
            },
            error: function(xml, info, obj) {
                logHandle.isgetLogProcessing = false;
            }
        });
    }
</script>

<script type="text/javascript">
    function getLogLevel(log) {
        if ( log.indexOf('[DEBUG]') != -1 ) {
            return 'DEBUG';
        } else if ( log.indexOf('[INFO]') != -1 ) {
            return 'INFO';
        } else if ( log.indexOf('[WARNING]') != -1 ) {
            return 'WARNING';
        } else if ( log.indexOf('[ERROR]') != -1 ) {
            return 'ERROR';
        } else if ( log.indexOf('[CRITICAL]') != -1 ) {
            return 'CRITICAL';
        }
        return 'DUMMY';
    }
</script>
